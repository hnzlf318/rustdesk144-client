name: Build Windows (32-bit and 64-bit)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-windows-64:
    name: Build Windows 64-bit
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-x86_64-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-x86_64-

      - name: Set up MSVC
        uses: microsoft/setup-msbuild@v1.1

      - name: Install CMake
        run: |
          if (-not (Get-Command cmake -ErrorAction SilentlyContinue)) {
            $cmakeVersion = "3.27.0"
            $cmakeUrl = "https://github.com/Kitware/CMake/releases/download/v$cmakeVersion/cmake-$cmakeVersion-windows-x86_64.zip"
            $cmakeZip = "$env:TEMP\cmake.zip"
            $cmakeDir = "$env:ProgramFiles\CMake"
            New-Item -ItemType Directory -Force -Path $cmakeDir | Out-Null
            Invoke-WebRequest -Uri $cmakeUrl -OutFile $cmakeZip
            Expand-Archive -Path $cmakeZip -DestinationPath $env:ProgramFiles -Force
            $env:Path = "$cmakeDir\bin;$env:Path"
            echo "$cmakeDir\bin" >> $env:GITHUB_PATH
          }
          cmake --version
        shell: pwsh

      - name: Set up vcpkg
        run: |
          $vcpkgRoot = "${{ github.workspace }}/vcpkg"
          git clone https://github.com/microsoft/vcpkg.git $vcpkgRoot
          cd $vcpkgRoot
          git checkout 120deac3062162151622ca4860575a33844ba10b
          & "$vcpkgRoot/bootstrap-vcpkg.bat" -disableMetrics
          echo "VCPKG_ROOT=$vcpkgRoot" >> $env:GITHUB_ENV
          echo "VCPKG_DEFAULT_TRIPLET=x64-windows-static" >> $env:GITHUB_ENV
          echo "VCPKG_INSTALLED_ROOT=$vcpkgRoot/installed" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Install vcpkg dependencies (64-bit)
        run: |
          $vcpkgRoot = "${{ github.workspace }}/vcpkg"
          $overlayPorts = "${{ github.workspace }}/res/vcpkg"
          cd "${{ github.workspace }}"
          & "$vcpkgRoot/vcpkg.exe" install --manifest --triplet x64-windows-static --overlay-ports="$overlayPorts" --x-install-root="$vcpkgRoot/installed"
        shell: pwsh

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Inline UI resources
        run: |
          python res/inline-sciter.py
        shell: cmd

      - name: Build virtual display library (64-bit)
        run: |
          cd libs/virtual_display/dylib
          cargo build --release --target x86_64-pc-windows-msvc
          cd ../../..
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
          VCPKG_INSTALLED_ROOT: ${{ github.workspace }}/vcpkg/installed
          VCPKG_DEFAULT_TRIPLET: x64-windows-static
        shell: cmd

      - name: Build (64-bit)
        run: |
          cargo build --release --target x86_64-pc-windows-msvc --features inline
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
          VCPKG_INSTALLED_ROOT: ${{ github.workspace }}/vcpkg/installed
          VCPKG_DEFAULT_TRIPLET: x64-windows-static
        shell: cmd

      - name: Upload 64-bit artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-windows-x86_64
          path: target/x86_64-pc-windows-msvc/release/rustdesk.exe
          retention-days: 30

  build-windows-32:
    name: Build Windows 32-bit
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: i686-pc-windows-msvc

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-i686-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-i686-

      - name: Set up MSVC
        uses: microsoft/setup-msbuild@v1.1

      - name: Install CMake
        run: |
          if (-not (Get-Command cmake -ErrorAction SilentlyContinue)) {
            $cmakeVersion = "3.27.0"
            $cmakeUrl = "https://github.com/Kitware/CMake/releases/download/v$cmakeVersion/cmake-$cmakeVersion-windows-x86_64.zip"
            $cmakeZip = "$env:TEMP\cmake.zip"
            $cmakeDir = "$env:ProgramFiles\CMake"
            New-Item -ItemType Directory -Force -Path $cmakeDir | Out-Null
            Invoke-WebRequest -Uri $cmakeUrl -OutFile $cmakeZip
            Expand-Archive -Path $cmakeZip -DestinationPath $env:ProgramFiles -Force
            $env:Path = "$cmakeDir\bin;$env:Path"
            echo "$cmakeDir\bin" >> $env:GITHUB_PATH
          }
          cmake --version
        shell: pwsh

      - name: Set up vcpkg
        run: |
          $vcpkgRoot = "${{ github.workspace }}/vcpkg"
          git clone https://github.com/microsoft/vcpkg.git $vcpkgRoot
          cd $vcpkgRoot
          git checkout 120deac3062162151622ca4860575a33844ba10b
          & "$vcpkgRoot/bootstrap-vcpkg.bat" -disableMetrics
          echo "VCPKG_ROOT=$vcpkgRoot" >> $env:GITHUB_ENV
          echo "VCPKG_DEFAULT_TRIPLET=x86-windows-static" >> $env:GITHUB_ENV
          echo "VCPKG_INSTALLED_ROOT=$vcpkgRoot/installed" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Install vcpkg dependencies (32-bit)
        run: |
          $vcpkgRoot = "${{ github.workspace }}/vcpkg"
          $overlayPorts = "${{ github.workspace }}/res/vcpkg"
          cd "${{ github.workspace }}"
          & "$vcpkgRoot/vcpkg.exe" install --manifest --triplet x86-windows-static --overlay-ports="$overlayPorts" --x-install-root="$vcpkgRoot/installed"
        shell: pwsh

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Inline UI resources
        run: |
          python res/inline-sciter.py
        shell: cmd

      - name: Build virtual display library (32-bit)
        run: |
          cd libs/virtual_display/dylib
          cargo build --release --target i686-pc-windows-msvc
          cd ../../..
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
          VCPKG_INSTALLED_ROOT: ${{ github.workspace }}/vcpkg/installed
          VCPKG_DEFAULT_TRIPLET: x86-windows-static
        shell: cmd

      - name: Build (32-bit)
        run: |
          cargo build --release --target i686-pc-windows-msvc --features inline
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
          VCPKG_INSTALLED_ROOT: ${{ github.workspace }}/vcpkg/installed
          VCPKG_DEFAULT_TRIPLET: x86-windows-static
        shell: cmd

      - name: Upload 32-bit artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-windows-i686
          path: target/i686-pc-windows-msvc/release/rustdesk.exe
          retention-days: 30

  package:
    name: Package Windows Builds
    runs-on: windows-latest
    needs: [build-windows-64, build-windows-32]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download 64-bit artifact
        uses: actions/download-artifact@v4
        with:
          name: rustdesk-windows-x86_64
          path: dist/x86_64

      - name: Download 32-bit artifact
        uses: actions/download-artifact@v4
        with:
          name: rustdesk-windows-i686
          path: dist/i686

      - name: Get version
        id: get_version
        run: |
          $version = (Select-String -Path "Cargo.toml" -Pattern '^version\s*=\s*"([^"]+)"' | ForEach-Object { $_.Matches.Groups[1].Value })
          echo "version=$version" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Create release archive (64-bit)
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          Compress-Archive -Path dist/x86_64/rustdesk.exe -DestinationPath "rustdesk-$version-x86_64.zip" -Force
        shell: pwsh

      - name: Create release archive (32-bit)
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          Compress-Archive -Path dist/i686/rustdesk.exe -DestinationPath "rustdesk-$version-i686.zip" -Force
        shell: pwsh

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-windows-releases
          path: |
            rustdesk-*-x86_64.zip
            rustdesk-*-i686.zip
          retention-days: 90

